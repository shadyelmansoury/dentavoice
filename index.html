<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="DentaVoice">
<meta name="theme-color" content="#0F172A">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop offset='0%25' stop-color='%233B82F6'/%3E%3Cstop offset='100%25' stop-color='%2306B6D4'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='64' height='64' rx='14' fill='%230F172A'/%3E%3Cpath d='M32 12c-4.5 0-8 1.5-10 4.5C20 19.5 19 24 19 28c0 3 .5 6 1.5 9 1.2 3.5 2.5 7 3.5 11 .8 3 1.5 5 2.5 5s2-2 2.5-5l1-4h4l1 4c.5 3 1.5 5 2.5 5s1.7-2 2.5-5c1-4 2.3-7.5 3.5-11 1-3 1.5-6 1.5-9 0-4-1-8.5-3-11.5-2-3-5.5-4.5-10-4.5z' fill='url(%23g)' opacity='.9'/%3E%3Cpath d='M15 30h3M46 30h3M13 26h3M48 26h3M14 34h3M47 34h3' stroke='%2360A5FA' stroke-width='1.5' stroke-linecap='round' opacity='.5'/%3E%3C/svg%3E">
<title>DentaVoice ‚Äî AI Clinical Notes</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Sora:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
:root {
  --navy: #0F172A;
  --navy-light: #1E293B;
  --slate-800: #1E293B;
  --slate-700: #334155;
  --slate-600: #475569;
  --slate-500: #64748B;
  --slate-400: #94A3B8;
  --slate-300: #CBD5E1;
  --slate-200: #E2E8F0;
  --slate-100: #F1F5F9;
  --slate-50: #F8FAFC;
  --blue-600: #2563EB;
  --blue-500: #3B82F6;
  --blue-400: #60A5FA;
  --blue-300: #93C5FD;
  --blue-200: #BFDBFE;
  --blue-100: #DBEAFE;
  --blue-50: #EFF6FF;
  --cyan-500: #06B6D4;
  --cyan-400: #22D3EE;
  --teal-500: #14B8A6;
  --amber-500: #F59E0B;
  --amber-400: #FBBF24;
  --red-500: #EF4444;
  --red-100: #FEE2E2;
  --green-500: #22C55E;
  --green-100: #DCFCE7;
  --purple-500: #A855F7;
  --purple-100: #F3E8FF;
  --rose-500: #F43F5E;
  --rose-100: #FFE4E6;
  --bg: var(--slate-50);
  --card: #ffffff;
  --border: var(--slate-200);
  --text: var(--navy);
  --text-mid: var(--slate-600);
  --text-light: var(--slate-400);
  --shadow-sm: 0 1px 3px rgba(15,23,42,0.06), 0 1px 2px rgba(15,23,42,0.04);
  --shadow-md: 0 4px 16px rgba(15,23,42,0.08), 0 2px 4px rgba(15,23,42,0.04);
  --shadow-lg: 0 12px 40px rgba(15,23,42,0.12), 0 4px 12px rgba(15,23,42,0.06);
  --shadow-xl: 0 20px 60px rgba(15,23,42,0.16), 0 8px 24px rgba(15,23,42,0.08);
  --shadow-glow: 0 0 30px rgba(59,130,246,0.15);
  --radius-sm: 10px;
  --radius-md: 14px;
  --radius-lg: 20px;
  --radius-xl: 24px;
}

* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

body {
  font-family: 'Outfit', system-ui, -apple-system, sans-serif;
  background: var(--bg); color: var(--text);
  min-height: 100vh; min-height: 100dvh;
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
}

/* ============================================
   ANIMATIONS
   ============================================ */
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(24px); }
  to { opacity: 1; transform: translateY(0); }
}
@keyframes fadeInDown {
  from { opacity: 0; transform: translateY(-16px); }
  to { opacity: 1; transform: translateY(0); }
}
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}
@keyframes scaleIn {
  from { opacity: 0; transform: scale(0.92); }
  to { opacity: 1; transform: scale(1); }
}
@keyframes slideInRight {
  from { opacity: 0; transform: translateX(30px); }
  to { opacity: 1; transform: translateX(0); }
}
@keyframes slideInLeft {
  from { opacity: 0; transform: translateX(-30px); }
  to { opacity: 1; transform: translateX(0); }
}
@keyframes float {
  0%, 100% { transform: translateY(0px) rotate(0deg); }
  33% { transform: translateY(-8px) rotate(1deg); }
  66% { transform: translateY(4px) rotate(-1deg); }
}
@keyframes shimmer {
  0% { background-position: -200% center; }
  100% { background-position: 200% center; }
}
@keyframes pulseGlow {
  0%, 100% { box-shadow: 0 0 0 0 rgba(59,130,246,0.3); }
  50% { box-shadow: 0 0 0 12px rgba(59,130,246,0); }
}
@keyframes ripple1 {
  0%, 100% { transform: translate(-50%,-50%) scale(1); opacity: 0.6; }
  50% { transform: translate(-50%,-50%) scale(1.3); opacity: 0; }
}
@keyframes ripple2 {
  0%, 100% { transform: translate(-50%,-50%) scale(1); opacity: 0.4; }
  50% { transform: translate(-50%,-50%) scale(1.5); opacity: 0; }
}
@keyframes ripple3 {
  0%, 100% { transform: translate(-50%,-50%) scale(1); opacity: 0.2; }
  50% { transform: translate(-50%,-50%) scale(1.7); opacity: 0; }
}
@keyframes spin { to { transform: rotate(360deg); } }
@keyframes dotPulse {
  0%, 80%, 100% { transform: scale(0); opacity: 0; }
  40% { transform: scale(1); opacity: 1; }
}
@keyframes waveBar {
  0%, 100% { height: 6px; }
  50% { height: 20px; }
}
@keyframes gradientShift {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}
@keyframes particleFloat {
  0% { transform: translateY(0) translateX(0) scale(1); opacity: 0; }
  10% { opacity: 1; }
  90% { opacity: 1; }
  100% { transform: translateY(-100vh) translateX(50px) scale(0); opacity: 0; }
}

.animate-in { animation: fadeInUp 0.6s cubic-bezier(0.16,1,0.3,1) both; }
.animate-in-d1 { animation-delay: 0.08s; }
.animate-in-d2 { animation-delay: 0.16s; }
.animate-in-d3 { animation-delay: 0.24s; }
.animate-in-d4 { animation-delay: 0.32s; }
.animate-in-d5 { animation-delay: 0.40s; }
.animate-in-d6 { animation-delay: 0.48s; }

/* ============================================
   AUTH SCREEN
   ============================================ */
.auth-screen {
  min-height: 100vh; min-height: 100dvh;
  display: flex; align-items: center; justify-content: center;
  position: relative; overflow: hidden;
  background: var(--navy);
}

.auth-bg {
  position: absolute; inset: 0; overflow: hidden;
  pointer-events: none;
}

.auth-bg::before {
  content: '';
  position: absolute;
  top: -50%; left: -50%;
  width: 200%; height: 200%;
  background:
    radial-gradient(ellipse at 20% 50%, rgba(59,130,246,0.15) 0%, transparent 50%),
    radial-gradient(ellipse at 80% 20%, rgba(6,182,212,0.1) 0%, transparent 50%),
    radial-gradient(ellipse at 50% 80%, rgba(168,85,247,0.08) 0%, transparent 50%);
  animation: gradientShift 15s ease-in-out infinite;
  background-size: 200% 200%;
}

.auth-particles {
  position: absolute; inset: 0; overflow: hidden;
}

.particle {
  position: absolute; bottom: -20px;
  width: 4px; height: 4px;
  background: var(--blue-400);
  border-radius: 50%;
  opacity: 0;
  animation: particleFloat linear infinite;
}

.auth-grid {
  position: absolute; inset: 0;
  background-image:
    linear-gradient(rgba(59,130,246,0.03) 1px, transparent 1px),
    linear-gradient(90deg, rgba(59,130,246,0.03) 1px, transparent 1px);
  background-size: 60px 60px;
}

.auth-card {
  position: relative; z-index: 10;
  background: rgba(255,255,255,0.97);
  backdrop-filter: blur(20px);
  border: 1px solid rgba(255,255,255,0.2);
  border-radius: var(--radius-xl);
  padding: 40px 32px;
  max-width: 400px; width: calc(100% - 40px);
  box-shadow: var(--shadow-xl), 0 0 80px rgba(59,130,246,0.08);
  animation: scaleIn 0.7s cubic-bezier(0.16,1,0.3,1) both;
}

.auth-logo { text-align: center; margin-bottom: 32px; animation: fadeInDown 0.7s cubic-bezier(0.16,1,0.3,1) 0.1s both; }

.logo-mark {
  width: 64px; height: 64px;
  margin: 0 auto 14px;
  position: relative;
  animation: float 6s ease-in-out infinite;
}

.logo-mark svg { width: 100%; height: 100%; }

.auth-logo-title {
  font-family: 'Sora', sans-serif;
  font-size: 28px; font-weight: 800;
  background: linear-gradient(135deg, var(--navy) 0%, var(--blue-600) 50%, var(--cyan-500) 100%);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  background-clip: text;
  letter-spacing: -0.03em;
}

.auth-logo-sub {
  font-size: 13px; color: var(--text-light); margin-top: 4px;
  font-weight: 400; letter-spacing: 0.02em;
}

.auth-tabs {
  display: flex; gap: 4px; margin-bottom: 28px;
  background: var(--slate-100); border-radius: var(--radius-sm); padding: 4px;
  animation: fadeInUp 0.6s cubic-bezier(0.16,1,0.3,1) 0.2s both;
}

.auth-tab {
  flex: 1; padding: 10px; text-align: center; font-size: 13px; font-weight: 600;
  cursor: pointer; border: none; background: transparent; color: var(--text-light);
  font-family: inherit; border-radius: 7px; transition: all 0.3s cubic-bezier(0.16,1,0.3,1);
  position: relative; letter-spacing: 0.01em;
}

.auth-tab.active {
  background: var(--card);
  color: var(--blue-600);
  box-shadow: var(--shadow-sm);
}

.auth-field {
  margin-bottom: 18px;
  animation: fadeInUp 0.5s cubic-bezier(0.16,1,0.3,1) both;
}
.auth-field:nth-child(1) { animation-delay: 0.25s; }
.auth-field:nth-child(2) { animation-delay: 0.3s; }
.auth-field:nth-child(3) { animation-delay: 0.35s; }

.auth-label {
  font-size: 11px; font-weight: 600; color: var(--slate-500);
  text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 6px; display: block;
}

.auth-input {
  width: 100%; padding: 13px 16px;
  border: 2px solid var(--slate-200); border-radius: var(--radius-sm);
  font-size: 15px; font-family: inherit; font-weight: 500;
  outline: none; transition: all 0.3s cubic-bezier(0.16,1,0.3,1);
  background: var(--slate-50); color: var(--text);
}

.auth-input:focus {
  border-color: var(--blue-500);
  background: white;
  box-shadow: 0 0 0 4px rgba(59,130,246,0.1);
}

.auth-input::placeholder { color: var(--slate-300); font-weight: 400; }

.auth-btn {
  width: 100%; padding: 14px;
  background: linear-gradient(135deg, var(--blue-600) 0%, var(--blue-500) 50%, var(--cyan-500) 100%);
  background-size: 200% 200%;
  color: #fff; border: none; border-radius: var(--radius-sm);
  font-size: 15px; font-weight: 700; cursor: pointer;
  font-family: inherit; margin-top: 10px;
  box-shadow: 0 4px 16px rgba(59,130,246,0.3);
  transition: all 0.3s cubic-bezier(0.16,1,0.3,1);
  animation: fadeInUp 0.5s cubic-bezier(0.16,1,0.3,1) 0.4s both;
  letter-spacing: 0.01em;
  position: relative; overflow: hidden;
}

.auth-btn::after {
  content: '';
  position: absolute; inset: 0;
  background: linear-gradient(135deg, transparent, rgba(255,255,255,0.15), transparent);
  background-size: 200% 100%;
  animation: shimmer 3s ease-in-out infinite;
}

.auth-btn:hover { background-size: 100% 100%; transform: translateY(-1px); box-shadow: 0 6px 24px rgba(59,130,246,0.35); }
.auth-btn:active { transform: translateY(0); box-shadow: 0 2px 8px rgba(59,130,246,0.3); }
.auth-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

.auth-error {
  background: var(--red-100); border: 1px solid #FECACA;
  border-radius: var(--radius-sm); padding: 11px 14px;
  font-size: 13px; color: #DC2626; font-weight: 500;
  margin-bottom: 16px; display: none;
  animation: scaleIn 0.3s ease both;
}
.auth-error.visible { display: block; }

.auth-footer {
  text-align: center; margin-top: 24px; font-size: 11px; color: var(--text-light);
  line-height: 1.6; letter-spacing: 0.02em;
  animation: fadeIn 0.6s 0.5s both;
}

.auth-footer .lock-icon {
  display: inline-flex; align-items: center; gap: 4px;
  background: var(--green-100); color: #16A34A;
  padding: 3px 10px; border-radius: 20px; font-weight: 600;
  font-size: 10px; margin-bottom: 4px;
}

/* ============================================
   HEADER
   ============================================ */
.header {
  background: var(--navy);
  padding: 14px 20px;
  display: flex; align-items: center; justify-content: space-between;
  position: sticky; top: 0; z-index: 100;
  box-shadow: 0 2px 24px rgba(15,23,42,0.2);
  animation: fadeInDown 0.5s cubic-bezier(0.16,1,0.3,1) both;
}

.header-left { display: flex; align-items: center; gap: 12px; }

.header-logo {
  width: 38px; height: 38px;
  background: linear-gradient(135deg, var(--blue-600), var(--cyan-500));
  border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  box-shadow: 0 2px 12px rgba(59,130,246,0.25);
  transition: transform 0.3s ease;
}
.header-logo:hover { transform: rotate(-5deg) scale(1.05); }
.header-logo svg { width: 22px; height: 22px; }

.header-title {
  font-family: 'Sora', sans-serif;
  font-size: 18px; font-weight: 700; color: #fff;
  letter-spacing: -0.02em;
}

.header-sub { font-size: 11px; color: var(--slate-400); margin-top: 0; font-weight: 400; }
.header-actions { display: flex; gap: 6px; align-items: center; }

.btn-header {
  background: var(--slate-700);
  border: 1px solid var(--slate-600);
  border-radius: var(--radius-sm);
  padding: 8px 13px; color: var(--slate-300);
  font-size: 12px; font-weight: 500;
  font-family: inherit; cursor: pointer;
  transition: all 0.2s ease;
  display: flex; align-items: center; gap: 5px;
}
.btn-header:hover { background: var(--slate-600); color: white; }
.btn-header:active { transform: scale(0.96); }

.btn-new {
  background: linear-gradient(135deg, var(--blue-600), var(--blue-500));
  border: none; border-radius: var(--radius-sm);
  padding: 8px 14px; color: #fff;
  font-size: 12px; font-weight: 600;
  font-family: inherit; cursor: pointer;
  display: none; transition: all 0.2s ease;
  box-shadow: 0 2px 8px rgba(59,130,246,0.3);
}
.btn-new.visible { display: flex; align-items: center; gap: 4px; }
.btn-new:active { transform: scale(0.96); }

/* ============================================
   MAIN CONTAINER
   ============================================ */
.app-screen { display: none; }
.app-screen.visible { display: block; }
.container { max-width: 720px; margin: 0 auto; padding: 16px 14px 120px; }

.card {
  background: var(--card);
  border-radius: var(--radius-lg);
  padding: 18px 20px;
  margin-bottom: 12px;
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border);
  transition: all 0.3s ease;
}

/* ============================================
   PATIENT INFO
   ============================================ */
.patient-row { display: flex; gap: 14px; flex-wrap: wrap; }
.field { flex: 1 1 160px; }
.field-small { flex: 0 1 120px; }

.field-label {
  font-size: 10px; font-weight: 700; color: var(--slate-400);
  text-transform: uppercase; letter-spacing: 0.08em;
}

.field-input {
  width: 100%; margin-top: 4px; padding: 9px 0;
  border: none; border-bottom: 2px solid var(--slate-200);
  font-size: 15px; font-weight: 600;
  background: transparent; outline: none;
  font-family: inherit; color: var(--text);
  transition: border-color 0.3s ease;
}
.field-input:focus { border-bottom-color: var(--blue-500); }
.field-input::placeholder { color: var(--slate-300); font-weight: 400; }

.error-box {
  background: var(--red-100); border: 1px solid #FECACA;
  border-radius: var(--radius-md); padding: 12px 16px;
  margin-bottom: 12px; font-size: 13px; font-weight: 500; color: #DC2626;
  display: none; align-items: center; gap: 8px;
  animation: scaleIn 0.3s ease;
}
.error-box.visible { display: flex; }

/* ============================================
   RECORDING
   ============================================ */
.record-card {
  text-align: center; padding: 32px 20px;
  border-radius: var(--radius-xl);
  background: linear-gradient(180deg, var(--card) 0%, var(--blue-50) 100%);
  border: 1px solid var(--blue-200);
}

.mic-wrapper { position: relative; display: inline-block; margin-bottom: 24px; }

.mic-ring-1, .mic-ring-2, .mic-ring-3 {
  position: absolute; top: 50%; left: 50%;
  transform: translate(-50%,-50%);
  border-radius: 50%; pointer-events: none; opacity: 0;
  border: 2px solid var(--blue-400);
}
.mic-ring-1 { width: 110px; height: 110px; }
.mic-ring-2 { width: 140px; height: 140px; }
.mic-ring-3 { width: 170px; height: 170px; }

body.recording .mic-ring-1 { animation: ripple1 2s ease-in-out infinite; }
body.recording .mic-ring-2 { animation: ripple2 2s ease-in-out infinite 0.3s; }
body.recording .mic-ring-3 { animation: ripple3 2s ease-in-out infinite 0.6s; }

.mic-btn {
  width: 88px; height: 88px; border-radius: 50%; border: none;
  background: linear-gradient(135deg, var(--blue-600), var(--blue-500));
  color: #fff; font-size: 36px; cursor: pointer;
  position: relative; z-index: 2;
  box-shadow: 0 6px 32px rgba(59,130,246,0.35);
  transition: all 0.3s cubic-bezier(0.16,1,0.3,1);
  display: flex; align-items: center; justify-content: center;
}
.mic-btn:hover { transform: scale(1.05); box-shadow: 0 8px 40px rgba(59,130,246,0.4); }
.mic-btn:active { transform: scale(0.95); }

body.recording .mic-btn {
  background: linear-gradient(135deg, #EF4444, #F87171);
  box-shadow: 0 6px 32px rgba(239,68,68,0.35);
  animation: pulseGlow 2s infinite;
}

.mic-status {
  font-size: 16px; font-weight: 700; color: var(--navy);
  margin-bottom: 2px; letter-spacing: -0.01em;
  font-family: 'Sora', sans-serif;
}
body.recording .mic-status { color: #EF4444; }

.mic-hint { font-size: 13px; color: var(--text-light); margin-bottom: 24px; font-weight: 400; }

/* Wave bars animation during recording */
.wave-bars {
  display: none; align-items: center; justify-content: center;
  gap: 3px; height: 24px; margin-bottom: 16px;
}
body.recording .wave-bars { display: flex; }

.wave-bar {
  width: 3px; height: 6px;
  background: var(--blue-500); border-radius: 2px;
  animation: waveBar 1.2s ease-in-out infinite;
}
.wave-bar:nth-child(1) { animation-delay: 0s; }
.wave-bar:nth-child(2) { animation-delay: 0.1s; }
.wave-bar:nth-child(3) { animation-delay: 0.2s; }
.wave-bar:nth-child(4) { animation-delay: 0.3s; }
.wave-bar:nth-child(5) { animation-delay: 0.4s; }
.wave-bar:nth-child(6) { animation-delay: 0.3s; }
.wave-bar:nth-child(7) { animation-delay: 0.2s; }

.transcript-box {
  background: white; border-radius: var(--radius-md); padding: 16px;
  min-height: 80px; text-align: left;
  border: 1px solid var(--slate-200);
}

.transcript-label {
  font-size: 10px; font-weight: 700; color: var(--slate-400);
  text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 8px;
}

.transcript-text { font-size: 14px; line-height: 1.7; color: var(--slate-700); }
.transcript-interim { color: var(--blue-400); font-style: italic; }
.transcript-placeholder { color: var(--slate-300); font-size: 13px; font-style: italic; }

.manual-input {
  width: 100%; margin-top: 12px; padding: 14px;
  border-radius: var(--radius-md); border: 2px solid var(--slate-200);
  font-size: 14px; font-family: inherit; min-height: 60px;
  resize: vertical; outline: none; transition: all 0.3s ease;
  background: white; color: var(--text);
}
.manual-input:focus { border-color: var(--blue-500); box-shadow: 0 0 0 4px rgba(59,130,246,0.08); }

.btn-process {
  margin-top: 20px; padding: 14px 32px;
  background: linear-gradient(135deg, var(--blue-600), var(--cyan-500));
  color: #fff; border: none; border-radius: var(--radius-md);
  font-size: 15px; font-weight: 700; cursor: pointer;
  box-shadow: 0 4px 20px rgba(59,130,246,0.3);
  font-family: inherit; display: none;
  align-items: center; gap: 8px;
  transition: all 0.3s cubic-bezier(0.16,1,0.3,1);
  position: relative; overflow: hidden;
  letter-spacing: 0.01em;
}
.btn-process::after {
  content: '';
  position: absolute; inset: 0;
  background: linear-gradient(135deg, transparent, rgba(255,255,255,0.1), transparent);
  background-size: 200% 100%;
  animation: shimmer 2.5s ease-in-out infinite;
}
.btn-process.visible { display: inline-flex; }
.btn-process:hover { transform: translateY(-2px); box-shadow: 0 8px 32px rgba(59,130,246,0.35); }
.btn-process:active { transform: translateY(0); }
.btn-process:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

/* ============================================
   STRUCTURED VIEW
   ============================================ */
.structured-view { display: none; }
.structured-view.visible { display: block; }
.record-view.hidden { display: none; }

.action-bar { display: flex; gap: 8px; margin-bottom: 14px; flex-wrap: wrap; }

.btn-action {
  padding: 10px 14px; background: var(--card);
  border: 1px solid var(--border); border-radius: var(--radius-sm);
  font-size: 12px; font-weight: 600; cursor: pointer;
  font-family: inherit; display: flex; align-items: center;
  gap: 6px; transition: all 0.2s ease;
  color: var(--slate-600);
}
.btn-action:hover { background: var(--slate-50); border-color: var(--slate-300); }
.btn-action:active { transform: scale(0.96); }
.btn-action.primary {
  background: linear-gradient(135deg, var(--blue-600), var(--blue-500));
  color: #fff; border: none; font-weight: 700;
  box-shadow: 0 2px 12px rgba(59,130,246,0.25);
}
.btn-action.primary:hover { box-shadow: 0 4px 20px rgba(59,130,246,0.3); }
.btn-action.copied { background: var(--green-500); color: #fff; border-color: var(--green-500); }

.patient-header {
  background: linear-gradient(135deg, var(--navy) 0%, var(--slate-800) 100%);
  border-radius: var(--radius-lg); padding: 18px 22px; margin-bottom: 10px;
  color: #fff; display: flex; justify-content: space-between; align-items: center;
  box-shadow: 0 4px 24px rgba(15,23,42,0.15);
  animation: fadeInUp 0.5s cubic-bezier(0.16,1,0.3,1) both;
}

.patient-header-name {
  font-size: 18px; font-weight: 800;
  font-family: 'Sora', sans-serif;
  letter-spacing: -0.02em;
}
.patient-header-meta { font-size: 12px; opacity: 0.6; margin-top: 3px; }

.section-count {
  background: rgba(59,130,246,0.2); border: 1px solid rgba(59,130,246,0.3);
  border-radius: var(--radius-sm);
  padding: 5px 12px; font-size: 11px; font-weight: 600;
  color: var(--blue-300);
}

.template-badge {
  display: inline-flex; align-items: center; gap: 6px;
  background: var(--blue-50); border: 1px solid var(--blue-200);
  border-radius: var(--radius-sm); padding: 7px 14px;
  font-size: 11px; font-weight: 600; color: var(--blue-600);
  margin-bottom: 10px;
  animation: fadeIn 0.4s 0.3s both;
}

.note-section {
  background: var(--card);
  border-radius: var(--radius-md);
  padding: 16px 20px;
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border);
  margin-bottom: 8px;
  transition: all 0.3s ease;
  animation: fadeInUp 0.4s cubic-bezier(0.16,1,0.3,1) both;
}
.note-section:hover { box-shadow: var(--shadow-md); border-color: var(--blue-200); }

.section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }

.section-title {
  font-size: 11px; font-weight: 700; color: var(--blue-600);
  text-transform: uppercase; letter-spacing: 0.04em;
  display: flex; align-items: center; gap: 6px;
}

.btn-edit {
  background: var(--slate-100); color: var(--slate-500); border: none;
  border-radius: 6px; padding: 5px 12px; font-size: 11px;
  font-weight: 600; cursor: pointer; font-family: inherit;
  transition: all 0.2s ease;
}
.btn-edit:hover { background: var(--slate-200); }
.btn-edit.saving { background: var(--blue-500); color: #fff; }

.section-content { font-size: 14px; line-height: 1.75; color: var(--slate-700); white-space: pre-wrap; }

.section-edit {
  width: 100%; padding: 12px; border-radius: 8px;
  border: 2px solid var(--blue-500); font-size: 14px;
  font-family: inherit; min-height: 55px; resize: vertical;
  outline: none; line-height: 1.6; display: none;
  background: var(--blue-50);
}

/* ============================================
   RECOMMENDATIONS
   ============================================ */
.recs-panel {
  background: linear-gradient(135deg, #FFFBEB 0%, #FEF3C7 100%);
  border: 1px solid #FDE68A; border-radius: var(--radius-lg);
  padding: 20px; margin-bottom: 12px; display: none;
  animation: fadeInUp 0.5s cubic-bezier(0.16,1,0.3,1) both;
}
.recs-panel.visible { display: block; }

.recs-header { display: flex; align-items: center; gap: 10px; margin-bottom: 16px; }

.recs-icon {
  width: 36px; height: 36px;
  background: linear-gradient(135deg, var(--amber-500), var(--amber-400));
  border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  font-size: 18px; box-shadow: 0 2px 8px rgba(245,158,11,0.3);
}

.recs-title { font-family: 'Sora', sans-serif; font-size: 16px; font-weight: 700; color: #92400E; letter-spacing: -0.01em; }
.recs-subtitle { font-size: 11px; color: #B45309; font-weight: 400; }

.rec-item {
  background: #fff; border: 1px solid #FDE68A;
  border-radius: var(--radius-md); padding: 14px 16px;
  margin-bottom: 8px; transition: all 0.3s ease;
}
.rec-item:hover { box-shadow: 0 2px 12px rgba(245,158,11,0.1); }
.rec-item.dismissed { opacity: 0.35; }

.rec-category {
  font-size: 9px; font-weight: 700; text-transform: uppercase;
  letter-spacing: 0.06em; padding: 3px 8px; border-radius: 5px;
  display: inline-block; margin-bottom: 6px;
}
.rec-category.clinical { background: var(--blue-100); color: var(--blue-600); }
.rec-category.followup { background: var(--green-100); color: #16A34A; }
.rec-category.medication { background: var(--purple-100); color: var(--purple-500); }
.rec-category.preventive { background: #FEF3C7; color: #92400E; }
.rec-category.diagnostic { background: var(--rose-100); color: var(--rose-500); }
.rec-category.safety { background: var(--red-100); color: var(--red-500); }

.rec-text { font-size: 13px; line-height: 1.65; color: var(--slate-600); }
.rec-actions { display: flex; gap: 6px; margin-top: 10px; }

.btn-rec {
  padding: 5px 14px; border-radius: 7px; font-size: 11px; font-weight: 600;
  cursor: pointer; font-family: inherit; border: none; transition: all 0.2s ease;
}
.btn-rec.accept { background: var(--green-100); color: #16A34A; }
.btn-rec.accept:hover { background: #BBF7D0; }
.btn-rec.accept:active { transform: scale(0.96); }
.btn-rec.dismiss { background: var(--slate-100); color: var(--slate-500); }
.btn-rec.dismiss:hover { background: var(--slate-200); }

.recs-disclaimer {
  font-size: 10px; color: #B45309; font-style: italic;
  margin-top: 12px; padding-top: 12px;
  border-top: 1px solid #FDE68A; line-height: 1.5;
}

/* ============================================
   LOADING
   ============================================ */
.loading-overlay {
  display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(15,23,42,0.6); z-index: 200;
  align-items: center; justify-content: center;
  backdrop-filter: blur(8px);
}
.loading-overlay.visible { display: flex; }

.loading-card {
  background: #fff; border-radius: var(--radius-xl);
  padding: 40px 32px; text-align: center;
  max-width: 300px; width: 90%;
  box-shadow: var(--shadow-xl);
  animation: scaleIn 0.4s cubic-bezier(0.16,1,0.3,1) both;
}

.loading-spinner {
  width: 52px; height: 52px;
  border: 3px solid var(--slate-200);
  border-top-color: var(--blue-500);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin: 0 auto 20px;
}

.loading-dots { display: flex; justify-content: center; gap: 6px; margin-bottom: 18px; }
.loading-dot {
  width: 8px; height: 8px;
  background: var(--blue-500); border-radius: 50%;
  animation: dotPulse 1.4s ease-in-out infinite;
}
.loading-dot:nth-child(2) { animation-delay: 0.16s; }
.loading-dot:nth-child(3) { animation-delay: 0.32s; }

.loading-title {
  font-family: 'Sora', sans-serif;
  font-size: 17px; font-weight: 700;
  color: var(--navy); margin-bottom: 6px;
  letter-spacing: -0.01em;
}

.loading-step { font-size: 13px; color: var(--text-light); font-weight: 400; }

/* ============================================
   SAVED NOTES
   ============================================ */
.saved-panel { display: none; }
.saved-panel.visible { display: block; }

.saved-empty { color: var(--text-light); font-size: 13px; padding: 20px 0; text-align: center; }

/* ============================================
   RAW DETAILS & TIPS
   ============================================ */
.raw-details { margin-top: 10px; }
.raw-details summary {
  font-size: 12px; font-weight: 600; color: var(--text-light);
  cursor: pointer; outline: none; padding: 14px 0;
  transition: color 0.2s;
}
.raw-details summary:hover { color: var(--blue-500); }
.raw-details-text { font-size: 12px; line-height: 1.7; color: var(--slate-500); font-style: italic; padding-bottom: 8px; white-space: pre-wrap; }

.tips-title {
  font-size: 15px; font-weight: 700; color: var(--navy);
  font-family: 'Sora', sans-serif; margin-bottom: 14px;
  letter-spacing: -0.01em;
  display: flex; align-items: center; gap: 8px;
}

.tip-row {
  display: flex; align-items: flex-start; gap: 12px;
  font-size: 13px; color: var(--slate-600); line-height: 1.6;
  margin-bottom: 10px;
}

.tip-num {
  background: var(--blue-100); color: var(--blue-600);
  border-radius: 8px; width: 24px; height: 24px; min-width: 24px;
  display: flex; align-items: center; justify-content: center;
  font-size: 11px; font-weight: 700; flex-shrink: 0;
}

/* ============================================
   SEARCH PANEL
   ============================================ */
.search-panel { display: none; }
.search-panel.visible { display: block; animation: fadeInDown 0.35s cubic-bezier(0.16,1,0.3,1) both; }

.search-header {
  display: flex; justify-content: space-between; align-items: center;
  margin-bottom: 14px;
}

.search-title {
  font-size: 16px; font-weight: 700;
  font-family: 'Sora', sans-serif;
  letter-spacing: -0.01em;
}

.btn-close-panel {
  background: var(--slate-100); border: none; border-radius: 8px;
  width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
  font-size: 14px; color: var(--slate-500); cursor: pointer;
  font-family: inherit; transition: all 0.2s;
}
.btn-close-panel:hover { background: var(--slate-200); color: var(--navy); }

.search-bar {
  position: relative; display: flex; align-items: center;
  background: var(--slate-50); border: 2px solid var(--slate-200);
  border-radius: var(--radius-sm); padding: 0 14px;
  transition: all 0.3s ease; margin-bottom: 14px;
}
.search-bar:focus-within { border-color: var(--blue-500); background: white; box-shadow: 0 0 0 4px rgba(59,130,246,0.08); }

.search-icon { color: var(--slate-400); flex-shrink: 0; }

.search-input {
  flex: 1; padding: 12px 10px; border: none; background: transparent;
  font-size: 15px; font-family: inherit; font-weight: 500;
  outline: none; color: var(--text);
}
.search-input::placeholder { color: var(--slate-300); font-weight: 400; }

.search-clear {
  background: none; border: none; font-size: 16px; color: var(--slate-400);
  cursor: pointer; padding: 4px; display: none; transition: color 0.2s;
}
.search-clear.visible { display: block; }
.search-clear:hover { color: var(--red-500); }

.search-result-group {
  margin-bottom: 14px;
  animation: fadeInUp 0.3s cubic-bezier(0.16,1,0.3,1) both;
}

.search-result-patient {
  display: flex; align-items: center; justify-content: space-between;
  padding: 12px 14px; background: var(--blue-50); border: 1px solid var(--blue-200);
  border-radius: var(--radius-sm); cursor: pointer;
  transition: all 0.2s ease; width: 100%; font-family: inherit; text-align: left;
}
.search-result-patient:hover { background: var(--blue-100); border-color: var(--blue-300); }
.search-result-patient:active { transform: scale(0.98); }

.search-result-info { display: flex; align-items: center; gap: 10px; }

.search-result-avatar {
  width: 36px; height: 36px; border-radius: 10px;
  background: linear-gradient(135deg, var(--blue-500), var(--cyan-500));
  display: flex; align-items: center; justify-content: center;
  font-size: 14px; font-weight: 700; color: white;
}

.search-result-name { font-size: 14px; font-weight: 700; color: var(--navy); }
.search-result-meta { font-size: 11px; color: var(--slate-500); margin-top: 1px; }
.search-result-visits {
  font-size: 11px; font-weight: 600; color: var(--blue-500);
  background: white; padding: 4px 10px; border-radius: 6px;
}

/* ============================================
   SAVED PANEL (IMPROVED)
   ============================================ */
.saved-panel { display: none; }
.saved-panel.visible { display: block; animation: fadeInDown 0.35s cubic-bezier(0.16,1,0.3,1) both; }

.saved-panel-header {
  display: flex; justify-content: space-between; align-items: center;
  margin-bottom: 14px;
}

.saved-title {
  font-size: 16px; font-weight: 700;
  font-family: 'Sora', sans-serif;
  margin-bottom: 0; letter-spacing: -0.01em;
  display: flex; align-items: center; gap: 8px;
}

.saved-empty { color: var(--text-light); font-size: 13px; padding: 20px 0; text-align: center; }

.saved-group { margin-bottom: 16px; }
.saved-group-label {
  font-size: 10px; font-weight: 700; color: var(--slate-400);
  text-transform: uppercase; letter-spacing: 0.08em;
  margin-bottom: 8px; padding-left: 2px;
}

.saved-item {
  background: var(--slate-50); border: 1px solid var(--border);
  border-radius: var(--radius-md); padding: 14px 16px;
  text-align: left; cursor: pointer;
  display: flex; justify-content: space-between; align-items: center;
  margin-bottom: 6px; width: 100%; font-family: inherit;
  transition: all 0.2s ease;
}
.saved-item:hover { background: var(--blue-50); border-color: var(--blue-200); }
.saved-item:active { transform: scale(0.98); }
.saved-item-left { display: flex; align-items: center; gap: 12px; }
.saved-item-avatar {
  width: 32px; height: 32px; border-radius: 8px;
  background: var(--slate-200);
  display: flex; align-items: center; justify-content: center;
  font-size: 12px; font-weight: 700; color: var(--slate-500);
  flex-shrink: 0;
}
.saved-item-name { font-weight: 700; font-size: 14px; color: var(--text); }
.saved-item-meta { font-size: 11px; color: var(--text-light); margin-top: 2px; }
.saved-item-arrow { color: var(--blue-400); font-size: 16px; font-weight: 700; }

/* ============================================
   PATIENT TIMELINE
   ============================================ */
.patient-timeline-panel { display: none; }
.patient-timeline-panel.visible { display: block; animation: fadeInUp 0.4s cubic-bezier(0.16,1,0.3,1) both; }

.timeline-header {
  display: flex; align-items: center; gap: 14px; margin-bottom: 12px;
}

.btn-back-timeline {
  background: var(--slate-100); border: none; border-radius: var(--radius-sm);
  padding: 8px 14px; font-size: 13px; font-weight: 600;
  color: var(--slate-600); cursor: pointer; font-family: inherit;
  transition: all 0.2s;
}
.btn-back-timeline:hover { background: var(--slate-200); }
.btn-back-timeline:active { transform: scale(0.96); }

.timeline-patient-name {
  font-size: 18px; font-weight: 800; color: var(--navy);
  font-family: 'Sora', sans-serif; letter-spacing: -0.02em;
}

.timeline-patient-id {
  font-size: 12px; color: var(--slate-500); font-weight: 500;
}

.timeline-count {
  font-size: 12px; font-weight: 600; color: var(--blue-500);
  margin-bottom: 14px;
  display: flex; align-items: center; gap: 6px;
}

.timeline-item {
  display: flex; gap: 14px; width: 100%; font-family: inherit;
  text-align: left; cursor: pointer; background: none; border: none;
  padding: 0; margin-bottom: 4px;
  transition: all 0.2s ease;
}
.timeline-item:active { transform: scale(0.98); }

.timeline-line {
  display: flex; flex-direction: column; align-items: center;
  width: 24px; flex-shrink: 0;
}

.timeline-dot {
  width: 12px; height: 12px; border-radius: 50%;
  background: var(--blue-500); border: 3px solid var(--blue-100);
  flex-shrink: 0;
}

.timeline-connector {
  width: 2px; flex: 1; min-height: 20px;
  background: var(--blue-200);
}

.timeline-content {
  flex: 1; background: var(--card); border: 1px solid var(--border);
  border-radius: var(--radius-md); padding: 14px 16px;
  margin-bottom: 8px;
  transition: all 0.2s ease;
}
.timeline-content:hover { border-color: var(--blue-200); box-shadow: var(--shadow-md); }

.timeline-date {
  font-size: 12px; font-weight: 700; color: var(--blue-600);
  margin-bottom: 4px;
}

.timeline-diagnosis {
  font-size: 13px; font-weight: 600; color: var(--navy);
  margin-bottom: 3px;
}

.timeline-treatment {
  font-size: 12px; color: var(--slate-500); line-height: 1.5;
}

.timeline-badges {
  display: flex; gap: 4px; margin-top: 8px; flex-wrap: wrap;
}

.timeline-badge {
  font-size: 9px; font-weight: 700; text-transform: uppercase;
  letter-spacing: 0.04em; padding: 2px 8px; border-radius: 4px;
  background: var(--slate-100); color: var(--slate-500);
}
.timeline-badge.has-recs { background: #FEF3C7; color: #92400E; }

/* ============================================
   TOAST
   ============================================ */
.toast {
  position: fixed; bottom: 32px; left: 50%;
  transform: translateX(-50%) translateY(80px);
  background: var(--navy); color: #fff;
  padding: 13px 28px; border-radius: var(--radius-md);
  font-size: 14px; font-weight: 600;
  box-shadow: var(--shadow-lg);
  z-index: 999; transition: all 0.4s cubic-bezier(0.16,1,0.3,1);
  pointer-events: none;
  display: flex; align-items: center; gap: 8px;
}
.toast.show { transform: translateX(-50%) translateY(0); }

/* ============================================
   USER BAR
   ============================================ */
.btn-logout {
  background: transparent;
  border: 1px solid var(--slate-600);
  border-radius: var(--radius-sm);
  padding: 7px 12px; color: var(--slate-400);
  font-size: 11px; font-weight: 500;
  font-family: inherit; cursor: pointer;
  transition: all 0.2s;
}
.btn-logout:hover { border-color: var(--slate-400); color: white; }

/* ============================================
   SPINNER INLINE
   ============================================ */
.spinner {
  display: inline-block; width: 16px; height: 16px;
  border: 2px solid rgba(255,255,255,0.3);
  border-top-color: #fff; border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

/* ============================================
   OCR / SCAN
   ============================================ */
.input-methods {
  display: flex; align-items: center; justify-content: center;
  gap: 20px; margin-bottom: 24px;
}

.method-btn {
  display: flex; flex-direction: column; align-items: center; gap: 8px;
  cursor: pointer; border: none; background: none; font-family: inherit;
  transition: all 0.3s cubic-bezier(0.16,1,0.3,1);
}
.method-btn:active { transform: scale(0.92); }

.method-icon {
  width: 88px; height: 88px; border-radius: 50%; border: none;
  display: flex; align-items: center; justify-content: center;
  font-size: 36px; cursor: pointer; position: relative; z-index: 2;
  transition: all 0.3s cubic-bezier(0.16,1,0.3,1);
}

.method-icon.mic-style {
  background: linear-gradient(135deg, var(--blue-600), var(--blue-500));
  color: #fff;
  box-shadow: 0 6px 32px rgba(59,130,246,0.35);
}
.method-icon.mic-style:hover { transform: scale(1.05); box-shadow: 0 8px 40px rgba(59,130,246,0.4); }

body.recording .method-icon.mic-style {
  background: linear-gradient(135deg, #EF4444, #F87171);
  box-shadow: 0 6px 32px rgba(239,68,68,0.35);
  animation: pulseGlow 2s infinite;
}

.method-icon.scan-style {
  background: linear-gradient(135deg, var(--cyan-500), var(--teal-500));
  color: #fff;
  box-shadow: 0 6px 32px rgba(6,182,212,0.3);
}
.method-icon.scan-style:hover { transform: scale(1.05); box-shadow: 0 8px 40px rgba(6,182,212,0.35); }

.method-label {
  font-size: 12px; font-weight: 600; color: var(--slate-500);
  letter-spacing: 0.01em;
}

.method-divider {
  font-size: 11px; font-weight: 600; color: var(--slate-300);
  text-transform: uppercase; letter-spacing: 0.1em;
  padding-bottom: 28px;
}

.ocr-preview {
  display: none; margin-top: 12px;
  background: var(--slate-50); border: 2px solid var(--blue-200);
  border-radius: var(--radius-md); padding: 12px;
  position: relative; animation: fadeInUp 0.4s cubic-bezier(0.16,1,0.3,1) both;
}
.ocr-preview.visible { display: block; }

.ocr-preview-header {
  display: flex; justify-content: space-between; align-items: center;
  margin-bottom: 10px;
}

.ocr-preview-label {
  font-size: 10px; font-weight: 700; color: var(--cyan-500);
  text-transform: uppercase; letter-spacing: 0.08em;
  display: flex; align-items: center; gap: 6px;
}

.btn-remove-img {
  background: var(--slate-200); border: none; border-radius: 6px;
  padding: 4px 10px; font-size: 10px; font-weight: 600;
  color: var(--slate-500); cursor: pointer; font-family: inherit;
  transition: all 0.2s;
}
.btn-remove-img:hover { background: var(--red-100); color: var(--red-500); }

.ocr-preview-img {
  max-width: 100%; max-height: 240px;
  border-radius: var(--radius-sm);
  object-fit: contain; display: block;
  margin: 0 auto;
  box-shadow: var(--shadow-sm);
}

.ocr-status {
  text-align: center; padding: 16px 0;
  font-size: 13px; color: var(--blue-500); font-weight: 600;
  display: flex; align-items: center; justify-content: center; gap: 8px;
}

.ocr-status .spinner {
  border-color: rgba(59,130,246,0.2);
  border-top-color: var(--blue-500);
}

.file-input-hidden { display: none; }

/* ============================================
   PATIENT HISTORY PANEL
   ============================================ */
.patient-history {
  display: none; margin-top: 12px;
  background: linear-gradient(135deg, var(--blue-50), #F0F9FF);
  border: 1px solid var(--blue-200);
  border-radius: var(--radius-md); padding: 14px 16px;
  animation: fadeInUp 0.4s cubic-bezier(0.16,1,0.3,1) both;
}
.patient-history.visible { display: block; }

.patient-history-header {
  display: flex; align-items: center; gap: 8px;
  margin-bottom: 10px;
}

.patient-history-icon {
  width: 28px; height: 28px;
  background: linear-gradient(135deg, var(--blue-500), var(--cyan-500));
  border-radius: 7px; display: flex; align-items: center; justify-content: center;
  font-size: 13px;
}

.patient-history-title {
  font-size: 13px; font-weight: 700; color: var(--navy);
  font-family: 'Sora', sans-serif;
}

.patient-history-count {
  font-size: 11px; color: var(--blue-500); font-weight: 500;
}

.history-item {
  background: white; border: 1px solid var(--blue-100);
  border-radius: var(--radius-sm); padding: 10px 14px;
  margin-bottom: 6px; cursor: pointer;
  display: flex; justify-content: space-between; align-items: center;
  width: 100%; font-family: inherit; text-align: left;
  transition: all 0.2s ease;
}
.history-item:hover { border-color: var(--blue-300); box-shadow: 0 2px 8px rgba(59,130,246,0.08); }
.history-item:active { transform: scale(0.98); }
.history-item-date { font-size: 13px; font-weight: 600; color: var(--navy); }
.history-item-preview { font-size: 11px; color: var(--slate-500); margin-top: 2px; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.history-item-arrow { color: var(--blue-400); font-size: 14px; font-weight: 700; }

/* Required field indicator */
.field-required::after {
  content: ' *'; color: var(--red-500); font-weight: 700;
}

.validation-msg {
  font-size: 11px; color: var(--red-500); font-weight: 500;
  margin-top: 4px; display: none;
  animation: fadeIn 0.3s ease;
}
.validation-msg.visible { display: block; }
</style>
</head>
<body>

<!-- ===== AUTH SCREEN ===== -->
<div class="auth-screen" id="authScreen">
  <div class="auth-bg">
    <div class="auth-grid"></div>
    <div class="auth-particles" id="authParticles"></div>
  </div>

  <div class="auth-card">
    <div class="auth-logo">
      <div class="logo-mark">
        <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <linearGradient id="logoGrad" x1="0" y1="0" x2="64" y2="64">
              <stop offset="0%" stop-color="#2563EB"/>
              <stop offset="100%" stop-color="#06B6D4"/>
            </linearGradient>
          </defs>
          <rect width="64" height="64" rx="16" fill="#0F172A"/>
          <path d="M32 12c-4.5 0-8 1.5-10 4.5C20 19.5 19 24 19 28c0 3 .5 6 1.5 9 1.2 3.5 2.5 7 3.5 11 .8 3 1.5 5 2.5 5s2-2 2.5-5l1-4h4l1 4c.5 3 1.5 5 2.5 5s1.7-2 2.5-5c1-4 2.3-7.5 3.5-11 1-3 1.5-6 1.5-9 0-4-1-8.5-3-11.5-2-3-5.5-4.5-10-4.5z" fill="url(#logoGrad)" opacity="0.9"/>
          <path d="M14 28h4M46 28h4M12 24h4M48 24h4M13 32h4M47 32h4" stroke="#60A5FA" stroke-width="1.8" stroke-linecap="round" opacity="0.5"/>
        </svg>
      </div>
      <div class="auth-logo-title">DentaVoice</div>
      <div class="auth-logo-sub">AI-Powered Clinical Notes</div>
    </div>

    <div class="auth-tabs">
      <button class="auth-tab active" id="tabLogin" onclick="switchAuthTab('login')">Log In</button>
      <button class="auth-tab" id="tabSignup" onclick="switchAuthTab('signup')">Sign Up</button>
    </div>

    <div class="auth-error" id="authError"></div>

    <div id="loginForm">
      <div class="auth-field"><label class="auth-label">Email</label><input class="auth-input" id="loginEmail" type="email" placeholder="name@clinic.com"></div>
      <div class="auth-field"><label class="auth-label">Password</label><input class="auth-input" id="loginPassword" type="password" placeholder="Enter your password"></div>
      <button class="auth-btn" id="loginBtn" onclick="handleLogin()">Log In</button>
    </div>

    <div id="signupForm" style="display:none;">
      <div class="auth-field"><label class="auth-label">Full Name</label><input class="auth-input" id="signupName" type="text" placeholder="Dr. Amira Mahmoud"></div>
      <div class="auth-field"><label class="auth-label">Email</label><input class="auth-input" id="signupEmail" type="email" placeholder="name@clinic.com"></div>
      <div class="auth-field"><label class="auth-label">Password</label><input class="auth-input" id="signupPassword" type="password" placeholder="Min 8 characters"></div>
      <button class="auth-btn" id="signupBtn" onclick="handleSignup()">Create Account</button>
    </div>

    <div class="auth-footer">
      <div class="lock-icon">üîí Encrypted</div><br>
      Patient data on Canadian servers ¬∑ PHIPA/PIPEDA compliant
    </div>
  </div>
</div>

<!-- ===== MAIN APP ===== -->
<div class="app-screen" id="appScreen">
  <div class="header">
    <div class="header-left" onclick="goHome()" style="cursor:pointer;">
      <div class="header-logo">
        <svg viewBox="0 0 32 32" fill="none"><path d="M16 5c-2.5 0-4.5.8-5.5 2.5S9 12 9 14.2c0 1.7.3 3.4.8 5 .7 2 1.4 4 2 6.3.4 1.5.8 2.7 1.4 2.7s1.1-1.1 1.4-2.7l.5-2.3h2l.5 2.3c.3 1.6.8 2.7 1.4 2.7s1-.9 1.4-2.7c.6-2.3 1.3-4.3 2-6.3.5-1.6.8-3.3.8-5 0-2.2-.6-4.8-1.7-6.5S18.5 5 16 5z" fill="white" opacity="0.95"/><path d="M6 14.5h2.5M23.5 14.5H26M5 12h2.5M24.5 12H27M5.5 17h2.5M24 17h2.5" stroke="white" stroke-width="1.2" stroke-linecap="round" opacity="0.4"/></svg>
      </div>
      <div>
        <div class="header-title">DentaVoice</div>
        <div class="header-sub" id="headerUser">Clinical Notes</div>
      </div>
    </div>
    <div class="header-actions">
      <button class="btn-header" id="btnSearch" onclick="toggleSearch()">üîç Search</button>
      <button class="btn-header" id="btnHistory" onclick="toggleSaved()">üìÇ History</button>
      <button class="btn-new" id="btnNew" onclick="startNew()">Ôºã New</button>
      <button class="btn-logout" onclick="handleLogout()">Log out</button>
    </div>
  </div>

  <div class="container">
    <!-- SEARCH PANEL -->
    <div class="card search-panel" id="searchPanel">
      <div class="search-header">
        <div class="search-title">üîç Search Patients</div>
        <button class="btn-close-panel" onclick="closeSearch()">‚úï</button>
      </div>
      <div class="search-bar">
        <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        <input class="search-input" id="searchInput" type="text" placeholder="Search by patient name or ID..." oninput="onSearchInput()">
        <button class="search-clear" id="searchClear" onclick="clearSearch()">‚úï</button>
      </div>
      <div id="searchResults"><div class="saved-empty">Type a name or ID to search</div></div>
    </div>

    <!-- HISTORY PANEL -->
    <div class="card saved-panel" id="savedPanel">
      <div class="saved-panel-header">
        <div class="saved-title">üìÇ All Records</div>
        <button class="btn-close-panel" onclick="closeSaved()">‚úï</button>
      </div>
      <div id="savedList"><div class="saved-empty">Loading notes...</div></div>
    </div>

    <!-- PATIENT TIMELINE PANEL -->
    <div class="card patient-timeline-panel" id="patientTimelinePanel">
      <div class="timeline-header">
        <button class="btn-back-timeline" onclick="closeTimeline()">‚Üê Back</button>
        <div>
          <div class="timeline-patient-name" id="timelinePatientName"></div>
          <div class="timeline-patient-id" id="timelinePatientId"></div>
        </div>
      </div>
      <div class="timeline-count" id="timelineCount"></div>
      <div id="timelineList"></div>
    </div>

    <div class="card animate-in">
      <div class="patient-row">
        <div class="field"><label class="field-label field-required">Patient Name</label><input class="field-input" id="patientName" placeholder="Enter patient name" oninput="onPatientInfoChange()"></div>
        <div class="field-small"><label class="field-label field-required">Patient ID</label><input class="field-input" id="patientId" placeholder="ID #" oninput="onPatientInfoChange()"></div>
        <div class="field-small"><label class="field-label">Visit Date</label><input class="field-input" id="visitDate" type="date"></div>
      </div>
      <div class="validation-msg" id="validationMsg">Patient name and ID are required to save a record.</div>
      <div class="patient-history" id="patientHistory">
        <div class="patient-history-header">
          <div class="patient-history-icon">üìã</div>
          <div>
            <div class="patient-history-title">Previous Records</div>
            <div class="patient-history-count" id="historyCount"></div>
          </div>
        </div>
        <div id="historyList"></div>
      </div>
    </div>

    <div class="error-box" id="errorBox"><span>‚ö†Ô∏è</span><span id="errorText"></span></div>

    <div class="record-view" id="recordView">
      <div class="card record-card animate-in animate-in-d1">
        <div class="input-methods">
          <button class="method-btn" onclick="toggleRecording()">
            <div class="mic-wrapper">
              <div class="mic-ring-1"></div>
              <div class="mic-ring-2"></div>
              <div class="mic-ring-3"></div>
              <div class="method-icon mic-style" id="micBtn">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" id="micIcon"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
              </div>
            </div>
            <span class="method-label" id="micLabel">Dictate</span>
          </button>
          <div class="method-divider">or</div>
          <button class="method-btn" onclick="triggerScan()">
            <div class="method-icon scan-style">
              <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
            </div>
            <span class="method-label">Scan Notes</span>
          </button>
        </div>
        <input type="file" accept="image/*" capture="environment" class="file-input-hidden" id="scanInput" onchange="handleScanInput(event)">
        <div class="wave-bars"><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div></div>
        <div class="mic-status" id="micStatus">Dictate or scan clinical notes</div>
        <div class="mic-hint" id="micHint">Voice record a patient visit, or photograph handwritten/printed notes</div>

        <div class="ocr-preview" id="ocrPreview">
          <div class="ocr-preview-header">
            <div class="ocr-preview-label">üì∑ Scanned Image</div>
            <button class="btn-remove-img" onclick="removeScannedImage()">‚úï Remove</button>
          </div>
          <img class="ocr-preview-img" id="ocrPreviewImg">
          <div class="ocr-status" id="ocrStatus" style="display:none;"><div class="spinner"></div> Extracting text from image...</div>
        </div>

        <div class="transcript-box">
          <div class="transcript-label">Live Transcript</div>
          <div id="transcriptArea"><div class="transcript-placeholder">Your dictation will appear here in real-time...</div></div>
        </div>
        <textarea class="manual-input" id="manualInput" placeholder="Or type / paste notes manually here..." oninput="onManualInput()"></textarea>
        <button class="btn-process" id="btnProcess" onclick="processNotes()">‚ú® Structure with AI</button>
      </div>

      <div class="card animate-in animate-in-d2" id="tipsCard">
        <div class="tips-title">üí° Tips for best results</div>
        <div class="tip-row"><span class="tip-num">1</span>Start with the chief complaint ‚Äî why the patient came in</div>
        <div class="tip-row"><span class="tip-num">2</span>Mention relevant medical history or allergies</div>
        <div class="tip-row"><span class="tip-num">3</span>Describe clinical findings with tooth numbers</div>
        <div class="tip-row"><span class="tip-num">4</span>State your diagnosis and any differentials</div>
        <div class="tip-row"><span class="tip-num">5</span>Detail the treatment, materials, and anesthesia</div>
        <div class="tip-row"><span class="tip-num">6</span>End with post-op instructions and follow-up plan</div>
      </div>
    </div>

    <div class="structured-view" id="structuredView">
      <div class="action-bar">
        <button class="btn-action" onclick="showRecordView()">üéô Edit</button>
        <button class="btn-action" id="btnCopy" onclick="copyAll()">üìã Copy</button>
        <button class="btn-action" onclick="exportPDF()">üìÑ PDF</button>
        <button class="btn-action" onclick="exportCSV()">üìä CSV</button>
        <button class="btn-action primary" onclick="saveNote()">üíæ Save</button>
      </div>
      <div class="patient-header"><div><div class="patient-header-name" id="structPatientName">Patient Notes</div><div class="patient-header-meta" id="structPatientMeta"></div></div><div class="section-count" id="sectionCount"></div></div>
      <div class="template-badge">üìÑ Standard Dental Clinical Note ‚Äî SOAP Format</div>
      <div id="sectionsContainer"></div>
      <div class="recs-panel" id="recsPanel">
        <div class="recs-header"><div class="recs-icon">üí°</div><div><div class="recs-title">Clinical Considerations</div><div class="recs-subtitle">AI-generated suggestions for your review</div></div></div>
        <div id="recsContainer"></div>
        <div class="recs-disclaimer">‚öïÔ∏è AI-generated suggestions only ‚Äî not clinical directives. Always apply professional judgment.</div>
      </div>
      <div class="card raw-details"><details><summary>View Raw Transcript</summary><div class="raw-details-text" id="rawTranscriptText"></div></details></div>
    </div>
  </div>
</div>

<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-card">
    <div class="loading-dots"><div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div></div>
    <div class="loading-title">Processing Notes</div>
    <div class="loading-step" id="loadingStep">Analyzing dictation...</div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ===== PARTICLES =====
(function(){
  const c = document.getElementById("authParticles");
  for(let i=0; i<20; i++){
    const p = document.createElement("div");
    p.className = "particle";
    p.style.left = Math.random()*100+"%";
    p.style.animationDuration = (8+Math.random()*12)+"s";
    p.style.animationDelay = Math.random()*10+"s";
    p.style.width = p.style.height = (2+Math.random()*4)+"px";
    p.style.opacity = 0.2+Math.random()*0.3;
    c.appendChild(p);
  }
})();

// ===== SUPABASE CONFIG =====
const SUPABASE_URL = "https://nzurgcoyjebxswkffduy.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im56dXJnY295amVieHN3a2ZmZHV5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1Njc3NDMsImV4cCI6MjA4NzE0Mzc0M30.yFxmvYYw2Uwgvb_TLrlOZn1IunDPZV80ejfY0gVbOAM";
const API_URL = "/api/claude-proxy";
const { createClient } = supabase;
const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ===== STATE =====
let currentUser = null, isRecording = false, recognition = null;
let rawTranscript = "", structuredNotes = null, recommendations = null;
let savedNotes = [], currentNoteId = null;

const LABELS = {
  subjective_chief_complaint:"S ‚Äî Chief Complaint", subjective_hpi:"S ‚Äî History of Present Illness",
  subjective_medical_history:"S ‚Äî Medical / Dental History", subjective_allergies:"S ‚Äî Allergies & Medications",
  objective_extraoral:"O ‚Äî Extraoral Examination", objective_intraoral:"O ‚Äî Intraoral Examination",
  objective_teeth_findings:"O ‚Äî Teeth & Periodontal Findings", objective_radiographic:"O ‚Äî Radiographic Findings",
  assessment_diagnosis:"A ‚Äî Diagnosis", assessment_differential:"A ‚Äî Differential Diagnosis",
  assessment_cdt_codes:"A ‚Äî CDT / Procedure Codes", plan_treatment_performed:"P ‚Äî Treatment Performed",
  plan_materials_used:"P ‚Äî Materials & Medications", plan_anesthesia:"P ‚Äî Anesthesia Details",
  plan_post_op:"P ‚Äî Post-Op Instructions", plan_follow_up:"P ‚Äî Follow-Up Plan",
  plan_referrals:"P ‚Äî Referrals", additional_notes:"Additional Notes"
};
const ICONS = {
  subjective_chief_complaint:"üí¨",subjective_hpi:"üìã",subjective_medical_history:"üè•",subjective_allergies:"‚ö†Ô∏è",
  objective_extraoral:"üë§",objective_intraoral:"üëÑ",objective_teeth_findings:"ü¶∑",objective_radiographic:"üì∑",
  assessment_diagnosis:"ü©∫",assessment_differential:"üî¨",assessment_cdt_codes:"üè∑Ô∏è",plan_treatment_performed:"‚öïÔ∏è",
  plan_materials_used:"üíä",plan_anesthesia:"üíâ",plan_post_op:"üìù",plan_follow_up:"üìÖ",
  plan_referrals:"üîó",additional_notes:"üìå"
};
const SECTION_GROUPS = {
  "Subjective":["subjective_chief_complaint","subjective_hpi","subjective_medical_history","subjective_allergies"],
  "Objective":["objective_extraoral","objective_intraoral","objective_teeth_findings","objective_radiographic"],
  "Assessment":["assessment_diagnosis","assessment_differential","assessment_cdt_codes"],
  "Plan":["plan_treatment_performed","plan_materials_used","plan_anesthesia","plan_post_op","plan_follow_up","plan_referrals"],
  "Other":["additional_notes"]
};

// ===== AUTH =====
function switchAuthTab(tab) {
  document.getElementById("tabLogin").classList.toggle("active", tab==="login");
  document.getElementById("tabSignup").classList.toggle("active", tab==="signup");
  document.getElementById("loginForm").style.display = tab==="login"?"block":"none";
  document.getElementById("signupForm").style.display = tab==="signup"?"block":"none";
  document.getElementById("authError").classList.remove("visible");
}

async function handleLogin() {
  const email=document.getElementById("loginEmail").value.trim(), pw=document.getElementById("loginPassword").value;
  if(!email||!pw){showAuthError("Please enter email and password.");return;}
  const btn=document.getElementById("loginBtn"); btn.disabled=true; btn.textContent="Logging in...";
  const{data,error}=await db.auth.signInWithPassword({email,password:pw});
  if(error){showAuthError(error.message);btn.disabled=false;btn.textContent="Log In";return;}
  currentUser=data.user; await logAudit("login","session",null,{method:"email"}); showApp();
}

async function handleSignup() {
  const name=document.getElementById("signupName").value.trim(), email=document.getElementById("signupEmail").value.trim(), pw=document.getElementById("signupPassword").value;
  if(!name||!email||!pw){showAuthError("Please fill in all fields.");return;}
  if(pw.length<8){showAuthError("Password must be at least 8 characters.");return;}
  const btn=document.getElementById("signupBtn"); btn.disabled=true; btn.textContent="Creating account...";
  const{data,error}=await db.auth.signUp({email,password:pw,options:{data:{full_name:name}}});
  if(error){showAuthError(error.message);btn.disabled=false;btn.textContent="Create Account";return;}
  if(data.user&&!data.user.confirmed_at){showAuthError("Check your email to confirm your account, then log in.");switchAuthTab("login");btn.disabled=false;btn.textContent="Create Account";return;}
  currentUser=data.user; showApp();
}

async function handleLogout() {
  await logAudit("logout","session",null,{});
  await db.auth.signOut(); currentUser=null;
  document.getElementById("appScreen").classList.remove("visible");
  document.getElementById("authScreen").style.display="flex";
  document.getElementById("loginBtn").disabled=false;
  document.getElementById("loginBtn").textContent="Log In";
}

function showAuthError(msg){const el=document.getElementById("authError");el.textContent=msg;el.classList.add("visible");}

async function initApp(){
  const{data:{session}}=await db.auth.getSession();
  if(session){currentUser=session.user;showApp();}
}

function showApp(){
  document.getElementById("authScreen").style.display="none";
  document.getElementById("appScreen").classList.add("visible");
  const name=currentUser.user_metadata?.full_name||currentUser.email;
  document.getElementById("headerUser").textContent=name;
  document.getElementById("visitDate").value=new Date().toISOString().split("T")[0];
  loadSavedNotes();
}

initApp();

// ===== AUDIT =====
async function logAudit(action,rType,rId,details){
  if(!currentUser)return;
  try{await db.from("audit_log").insert({user_id:currentUser.id,action,resource_type:rType,resource_id:rId,details});}catch(e){}
}

// ===== RECORDING =====
function toggleRecording(){isRecording?stopRecording():startRecording();}

function startRecording(){
  hideError();
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){showError("Speech recognition not supported. Please use Chrome.");return;}
  recognition=new SR(); recognition.continuous=true; recognition.interimResults=true; recognition.lang="en-US";
  recognition.onresult=function(e){
    let interim="",final="";
    for(let i=e.resultIndex;i<e.results.length;i++){const t=e.results[i][0].transcript;if(e.results[i].isFinal)final+=t+" ";else interim+=t;}
    if(final){rawTranscript+=final;document.getElementById("manualInput").value=rawTranscript;}
    updateTranscriptDisplay(interim);
  };
  recognition.onerror=function(e){
    if(e.error==="not-allowed"){showError("Microphone access denied.");stopRecording();}
    else if(e.error!=="no-speech"&&e.error!=="aborted")showError("Speech error: "+e.error);
  };
  recognition.onend=function(){if(isRecording)try{recognition.start();}catch(e){}};
  try{
    recognition.start();isRecording=true;document.body.classList.add("recording");
    document.getElementById("micIcon").innerHTML='<rect x="6" y="4" width="12" height="16" rx="2" fill="currentColor"/>';
    document.getElementById("micLabel").textContent="Stop";
    document.getElementById("micStatus").textContent="Listening... Tap mic to stop";
    document.getElementById("micHint").textContent="Speak naturally ‚Äî describe the patient visit";
    document.getElementById("manualInput").style.display="none";
    updateProcessBtn();
  }catch(e){showError("Could not start recording.");}
}

function stopRecording(){
  if(recognition){recognition.onend=null;recognition.stop();recognition=null;}
  isRecording=false;document.body.classList.remove("recording");
  document.getElementById("micIcon").innerHTML='<path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/>';
  document.getElementById("micLabel").textContent="Dictate";
  document.getElementById("micStatus").textContent="Dictate or scan clinical notes";
  document.getElementById("micHint").textContent="Voice record a patient visit, or photograph handwritten/printed notes";
  document.getElementById("manualInput").style.display="block";
  updateProcessBtn();
}

function updateTranscriptDisplay(interim){
  const area=document.getElementById("transcriptArea");
  if(rawTranscript||interim)area.innerHTML='<span class="transcript-text">'+esc(rawTranscript)+'</span>'+(interim?'<span class="transcript-interim">'+esc(interim)+'</span>':'');
  else area.innerHTML='<div class="transcript-placeholder">Your dictation will appear here...</div>';
}

function onManualInput(){rawTranscript=document.getElementById("manualInput").value;updateTranscriptDisplay("");updateProcessBtn();}

// ===== OCR / SCAN =====
function triggerScan() {
  document.getElementById("scanInput").click();
}

async function handleScanInput(event) {
  const file = event.target.files[0];
  if (!file) return;

  // Validate file type
  if (!file.type.startsWith("image/")) {
    showError("Please select an image file (photo of notes).");
    return;
  }

  // Validate file size (max 10MB)
  if (file.size > 10 * 1024 * 1024) {
    showError("Image is too large. Please use a smaller photo (under 10MB).");
    return;
  }

  hideError();

  // Show image preview
  const preview = document.getElementById("ocrPreview");
  const previewImg = document.getElementById("ocrPreviewImg");
  const reader = new FileReader();

  reader.onload = async function(e) {
    const dataUrl = e.target.result;
    previewImg.src = dataUrl;
    preview.classList.add("visible");

    // Extract base64 data and media type
    const base64 = dataUrl.split(",")[1];
    const mediaType = file.type; // image/jpeg, image/png, etc.

    // Show extracting status
    document.getElementById("ocrStatus").style.display = "flex";

    try {
      const response = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          mode: "ocr",
          image: base64,
          media_type: mediaType,
        }),
      });

      const data = await response.json();
      document.getElementById("ocrStatus").style.display = "none";

      if (data.error) {
        showError("OCR failed: " + data.error);
        return;
      }

      if (data.extracted_text) {
        // Auto-fill patient name and ID if extracted from scan
        if (data.patient_name && !document.getElementById("patientName").value.trim()) {
          document.getElementById("patientName").value = data.patient_name;
        }
        if (data.patient_id && !document.getElementById("patientId").value.trim()) {
          document.getElementById("patientId").value = data.patient_id;
        }

        // Look up previous records for this patient
        if (data.patient_name || data.patient_id) {
          lookupPatientHistory();
        }

        // Append extracted text to existing transcript
        const separator = rawTranscript.trim() ? "\n\n--- Scanned Notes ---\n" : "";
        rawTranscript += separator + data.extracted_text;
        document.getElementById("manualInput").value = rawTranscript;
        updateTranscriptDisplay("");
        updateProcessBtn();

        if (data.usage) console.log("OCR usage:", data.usage);

        const autoFilled = [];
        if (data.patient_name) autoFilled.push("name");
        if (data.patient_id) autoFilled.push("ID");
        const extra = autoFilled.length ? " ¬∑ Patient " + autoFilled.join(" & ") + " detected" : "";
        showToast("‚úì Text extracted" + extra);
        await logAudit("ocr_scan", "patient_notes", null, { file_type: mediaType, file_size: file.size, patient_detected: !!data.patient_name });
      }
    } catch (err) {
      document.getElementById("ocrStatus").style.display = "none";
      showError("Failed to extract text: " + err.message);
    }
  };

  reader.readAsDataURL(file);

  // Reset file input so same file can be selected again
  event.target.value = "";
}

function removeScannedImage() {
  document.getElementById("ocrPreview").classList.remove("visible");
  document.getElementById("ocrPreviewImg").src = "";
  document.getElementById("ocrStatus").style.display = "none";
}

// ===== PATIENT HISTORY LOOKUP =====
let historyLookupTimer = null;

function onPatientInfoChange() {
  // Hide validation message when user starts typing
  document.getElementById("validationMsg").classList.remove("visible");

  // Debounce: wait 600ms after user stops typing before searching
  clearTimeout(historyLookupTimer);
  historyLookupTimer = setTimeout(() => lookupPatientHistory(), 600);
}

async function lookupPatientHistory() {
  if (!currentUser) return;
  const name = document.getElementById("patientName").value.trim();
  const pid = document.getElementById("patientId").value.trim();

  if (!name && !pid) {
    document.getElementById("patientHistory").classList.remove("visible");
    return;
  }

  try {
    let query = db.from("patient_notes")
      .select("id, patient_name, patient_id, visit_date, structured_notes")
      .eq("status", "active")
      .order("visit_date", { ascending: false })
      .limit(10);

    // Search by patient ID first (most specific), otherwise by name
    if (pid) {
      query = query.eq("patient_id", pid);
    } else if (name) {
      query = query.ilike("patient_name", "%" + name + "%");
    }

    const { data, error } = await query;
    if (error) throw error;

    // Exclude the current note from results
    const records = (data || []).filter(n => n.id !== currentNoteId);

    const panel = document.getElementById("patientHistory");
    const list = document.getElementById("historyList");
    const count = document.getElementById("historyCount");

    if (records.length === 0) {
      panel.classList.remove("visible");
      return;
    }

    panel.classList.add("visible");
    count.textContent = records.length + " previous visit" + (records.length > 1 ? "s" : "");

    list.innerHTML = records.map(n => {
      let preview = "";
      if (n.structured_notes) {
        const notes = n.structured_notes;
        preview = notes.subjective_chief_complaint || notes.assessment_diagnosis || notes.plan_treatment_performed || "";
        if (preview.length > 60) preview = preview.substring(0, 60) + "...";
      }
      return '<button class="history-item" onclick="loadNote(\'' + n.id + '\')">' +
        '<div><div class="history-item-date">' + n.visit_date + '</div>' +
        (preview ? '<div class="history-item-preview">' + esc(preview) + '</div>' : '') +
        '</div><div class="history-item-arrow">‚Üí</div></button>';
    }).join("");

    // Add "View full timeline" link
    const viewAllName = document.getElementById("patientName").value.trim();
    const viewAllId = document.getElementById("patientId").value.trim();
    list.innerHTML += '<button class="history-item" style="justify-content:center;color:var(--blue-500);font-weight:600;font-size:12px;" onclick="showPatientTimeline(\''+esc(viewAllName)+'\',\''+esc(viewAllId)+'\')">View full patient timeline ‚Üí</button>';
  } catch (e) {
    console.warn("History lookup failed:", e);
  }
}

function updateProcessBtn(){
  const has=rawTranscript.trim().length>0;
  document.getElementById("btnProcess").classList.toggle("visible",has&&!isRecording);
  document.getElementById("tipsCard").style.display=(has||isRecording)?"none":"block";
  document.getElementById("btnNew").classList.toggle("visible",has||!!structuredNotes);
}

// ===== AI =====
async function processNotes(){
  rawTranscript=document.getElementById("manualInput").value||rawTranscript;
  if(!rawTranscript.trim()){showError("No notes to process.");return;}
  showLoading("Analyzing dictation...");hideError();
  try{
    updateLoadingStep("Structuring notes & generating insights...");
    const r=await fetch(API_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({transcript:rawTranscript.trim()})});
    const data=await r.json();if(data.error)throw new Error(data.error);
    structuredNotes=data.notes||{};recommendations=data.recommendations||[];
    if(data.usage)console.log("Usage:",data.usage);
    await logAudit("process_notes","patient_notes",null,{patient_name:document.getElementById("patientName").value});
    hideLoading();showStructuredView();
  }catch(err){hideLoading();showError("Failed: "+err.message);}
}

// ===== STRUCTURED VIEW =====
function showStructuredView(){
  document.getElementById("recordView").classList.add("hidden");
  document.getElementById("structuredView").classList.add("visible");
  const name=document.getElementById("patientName").value||"Patient Notes";
  const id=document.getElementById("patientId").value;
  const date=document.getElementById("visitDate").value;
  document.getElementById("structPatientName").textContent=name;
  document.getElementById("structPatientMeta").textContent=date+(id?" ¬∑ ID: "+id:"");
  const entries=Object.entries(structuredNotes).filter(([k,v])=>v&&LABELS[k]);
  document.getElementById("sectionCount").textContent=entries.length+" sections";
  const container=document.getElementById("sectionsContainer");container.innerHTML="";
  let idx=0;
  Object.entries(SECTION_GROUPS).forEach(([g,keys])=>{
    keys.filter(k=>structuredNotes[k]&&String(structuredNotes[k]).trim()).forEach(key=>{
      const s=document.createElement("div");s.className="note-section";s.id="section-"+key;
      s.style.animationDelay=(0.1+idx*0.06)+"s";
      s.innerHTML='<div class="section-header"><div class="section-title">'+(ICONS[key]||"üìù")+" "+LABELS[key]+'</div><button class="btn-edit" onclick="toggleEdit(\''+key+'\')">Edit</button></div><div class="section-content" id="content-'+key+'">'+esc(String(structuredNotes[key]))+'</div><textarea class="section-edit" id="edit-'+key+'">'+esc(String(structuredNotes[key]))+'</textarea>';
      container.appendChild(s);idx++;
    });
  });
  renderRecommendations();
  document.getElementById("rawTranscriptText").textContent=rawTranscript;
  document.getElementById("btnNew").classList.add("visible");
}

function renderRecommendations(){
  const panel=document.getElementById("recsPanel"),container=document.getElementById("recsContainer");
  if(!recommendations||!recommendations.length){panel.classList.remove("visible");return;}
  panel.classList.add("visible");container.innerHTML="";
  const order={high:0,medium:1,low:2};
  [...recommendations].sort((a,b)=>(order[a.priority]||2)-(order[b.priority]||2)).forEach((rec,i)=>{
    const item=document.createElement("div");item.className="rec-item";item.id="rec-"+i;
    item.innerHTML='<span class="rec-category '+(rec.category||"clinical")+'">'+(rec.category||"").toUpperCase()+(rec.priority==="high"?" ‚óè":"")+'</span><div style="font-size:14px;font-weight:700;color:var(--navy);margin-bottom:4px;">'+esc(rec.title)+'</div><div class="rec-text">'+esc(rec.detail)+'</div><div class="rec-actions"><button class="btn-rec accept" onclick="acceptRec('+i+')">‚úì Noted</button><button class="btn-rec dismiss" onclick="dismissRec('+i+')">‚úï Dismiss</button></div>';
    container.appendChild(item);
  });
}

function acceptRec(i){const el=document.getElementById("rec-"+i);if(el){el.style.borderColor="#86EFAC";el.style.background="#F0FDF4";el.querySelector(".rec-actions").innerHTML='<span style="font-size:11px;color:#16A34A;font-weight:600;">‚úì Noted</span>';}}
function dismissRec(i){const el=document.getElementById("rec-"+i);if(el){el.classList.add("dismissed");el.querySelector(".rec-actions").innerHTML='<span style="font-size:11px;color:#999;">Dismissed</span>';}}
function showRecordView(){document.getElementById("structuredView").classList.remove("visible");document.getElementById("recordView").classList.remove("hidden");}

function toggleEdit(key){
  const c=document.getElementById("content-"+key),e=document.getElementById("edit-"+key),b=document.querySelector("#section-"+key+" .btn-edit");
  if(e.style.display==="block"){structuredNotes[key]=e.value;c.textContent=e.value;c.style.display="block";e.style.display="none";b.textContent="Edit";b.classList.remove("saving");}
  else{c.style.display="none";e.style.display="block";e.focus();b.textContent="‚úì Save";b.classList.add("saving");}
}

// ===== DATABASE =====
async function saveNote(){
  // Validate required fields
  const patientName = document.getElementById("patientName").value.trim();
  const patientId = document.getElementById("patientId").value.trim();

  if (!patientName || !patientId) {
    document.getElementById("validationMsg").classList.add("visible");
    // Highlight empty fields
    if (!patientName) {
      const el = document.getElementById("patientName");
      el.style.borderBottomColor = "var(--red-500)";
      el.focus();
      setTimeout(() => el.style.borderBottomColor = "", 3000);
    }
    if (!patientId) {
      const el = document.getElementById("patientId");
      el.style.borderBottomColor = "var(--red-500)";
      if (patientName) el.focus();
      setTimeout(() => el.style.borderBottomColor = "", 3000);
    }
    showToast("‚ö†Ô∏è Patient name and ID required");
    return;
  }

  const noteData={user_id:currentUser.id,patient_name:patientName,patient_id:patientId,visit_date:document.getElementById("visitDate").value,raw_transcript:rawTranscript,structured_notes:structuredNotes,recommendations};
  try{
    let result;
    if(currentNoteId){result=await db.from("patient_notes").update(noteData).eq("id",currentNoteId).select();await logAudit("update_note","patient_notes",currentNoteId,{patient_name:noteData.patient_name});}
    else{result=await db.from("patient_notes").insert(noteData).select();if(result.data&&result.data[0])currentNoteId=result.data[0].id;await logAudit("create_note","patient_notes",currentNoteId,{patient_name:noteData.patient_name});}
    if(result.error)throw result.error;
    showToast("‚úì Saved to secure database");loadSavedNotes();
  }catch(e){showError("Failed to save: "+e.message);}
}

async function loadSavedNotes(){
  try{
    const{data,error}=await db.from("patient_notes").select("id,patient_name,patient_id,visit_date,created_at").eq("status","active").order("visit_date",{ascending:false}).limit(50);
    if(error)throw error;savedNotes=data||[];renderSavedList();
  }catch(e){console.warn("Load failed:",e);}
}

function renderSavedList(){
  const list=document.getElementById("savedList");
  document.getElementById("btnHistory").textContent="üìÇ History"+(savedNotes.length>0?" ("+savedNotes.length+")":"");
  if(!savedNotes.length){list.innerHTML='<div class="saved-empty">No saved notes yet. Create your first note above.</div>';return;}

  // Group notes by relative date
  const groups = {};
  const now = new Date();
  const today = now.toISOString().split("T")[0];
  const yesterday = new Date(now - 86400000).toISOString().split("T")[0];
  const weekAgo = new Date(now - 7*86400000).toISOString().split("T")[0];

  savedNotes.forEach(n => {
    let label;
    if(n.visit_date === today) label = "Today";
    else if(n.visit_date === yesterday) label = "Yesterday";
    else if(n.visit_date >= weekAgo) label = "This Week";
    else label = "Older";
    if(!groups[label]) groups[label] = [];
    groups[label].push(n);
  });

  let html = "";
  ["Today","Yesterday","This Week","Older"].forEach(label => {
    if(!groups[label]) return;
    html += '<div class="saved-group"><div class="saved-group-label">'+label+'</div>';
    html += groups[label].map(n => {
      const initials = (n.patient_name||"?").split(" ").map(w=>w[0]).join("").substring(0,2).toUpperCase();
      return '<button class="saved-item" onclick="loadNote(\''+n.id+'\')">'+
        '<div class="saved-item-left"><div class="saved-item-avatar">'+initials+'</div><div><div class="saved-item-name">'+esc(n.patient_name)+'</div>'+
        '<div class="saved-item-meta">'+n.visit_date+(n.patient_id?" ¬∑ ID: "+n.patient_id:"")+'</div></div></div>'+
        '<div class="saved-item-arrow">‚Üí</div></button>';
    }).join("");
    html += '</div>';
  });
  list.innerHTML = html;
}

async function loadNote(id){
  try{
    const{data,error}=await db.from("patient_notes").select("*").eq("id",id).single();if(error)throw error;
    currentNoteId=data.id;document.getElementById("patientName").value=data.patient_name||"";
    document.getElementById("patientId").value=data.patient_id||"";document.getElementById("visitDate").value=data.visit_date||"";
    rawTranscript=data.raw_transcript||"";document.getElementById("manualInput").value=rawTranscript;
    structuredNotes=data.structured_notes;recommendations=data.recommendations||[];
    await logAudit("view_note","patient_notes",id,{patient_name:data.patient_name});
    if(structuredNotes)showStructuredView();else{showRecordView();updateTranscriptDisplay("");updateProcessBtn();}
    closeSaved(); closeSearch(); closeTimeline();
  }catch(e){showError("Failed to load: "+e.message);}
}

function toggleSaved(){
  closeSearch(); closeTimeline();
  document.getElementById("savedPanel").classList.toggle("visible");
}
function closeSaved(){ document.getElementById("savedPanel").classList.remove("visible"); }

function goHome(){
  closeSaved(); closeSearch(); closeTimeline();
  // If viewing a structured note, go back to record view
  if(document.getElementById("structuredView").classList.contains("visible")){
    // Keep the note loaded, just scroll up
  }
  // Scroll to top
  window.scrollTo({ top: 0, behavior: "smooth" });
}

// ===== SEARCH =====
let searchTimer = null;

function toggleSearch(){
  closeSaved(); closeTimeline();
  const panel = document.getElementById("searchPanel");
  panel.classList.toggle("visible");
  if(panel.classList.contains("visible")){
    setTimeout(() => document.getElementById("searchInput").focus(), 100);
  }
}
function closeSearch(){
  document.getElementById("searchPanel").classList.remove("visible");
  document.getElementById("searchInput").value = "";
  document.getElementById("searchClear").classList.remove("visible");
}

function clearSearch(){
  document.getElementById("searchInput").value = "";
  document.getElementById("searchClear").classList.remove("visible");
  document.getElementById("searchResults").innerHTML = '<div class="saved-empty">Type a name or ID to search</div>';
  document.getElementById("searchInput").focus();
}

function onSearchInput(){
  const q = document.getElementById("searchInput").value.trim();
  document.getElementById("searchClear").classList.toggle("visible", q.length > 0);
  clearTimeout(searchTimer);
  if(q.length < 2){
    document.getElementById("searchResults").innerHTML = '<div class="saved-empty">Type at least 2 characters to search</div>';
    return;
  }
  searchTimer = setTimeout(() => performSearch(q), 300);
}

async function performSearch(query){
  if(!currentUser) return;
  document.getElementById("searchResults").innerHTML = '<div class="saved-empty">Searching...</div>';
  try{
    // Search by name OR by patient ID
    const { data: byName } = await db.from("patient_notes")
      .select("id, patient_name, patient_id, visit_date, structured_notes")
      .eq("status","active").ilike("patient_name", "%"+query+"%")
      .order("visit_date",{ascending:false}).limit(50);

    const { data: byId } = await db.from("patient_notes")
      .select("id, patient_name, patient_id, visit_date, structured_notes")
      .eq("status","active").ilike("patient_id", "%"+query+"%")
      .order("visit_date",{ascending:false}).limit(50);

    // Merge and deduplicate
    const allResults = [...(byName||[]), ...(byId||[])];
    const seen = new Set();
    const unique = allResults.filter(n => {
      if(seen.has(n.id)) return false;
      seen.add(n.id); return true;
    });

    // Group by patient (using patient_id as key, fallback to name)
    const patients = {};
    unique.forEach(n => {
      const key = (n.patient_id || n.patient_name || "unknown").toLowerCase();
      if(!patients[key]) patients[key] = { name: n.patient_name, id: n.patient_id, visits: [] };
      patients[key].visits.push(n);
    });

    renderSearchResults(patients);
  }catch(e){
    document.getElementById("searchResults").innerHTML = '<div class="saved-empty">Search failed. Try again.</div>';
  }
}

function renderSearchResults(patients){
  const container = document.getElementById("searchResults");
  const keys = Object.keys(patients);
  if(!keys.length){
    container.innerHTML = '<div class="saved-empty">No patients found</div>';
    return;
  }
  container.innerHTML = keys.map((key,i) => {
    const p = patients[key];
    const initials = (p.name || "?").split(" ").map(w=>w[0]).join("").substring(0,2).toUpperCase();
    const visitText = p.visits.length + " visit" + (p.visits.length > 1 ? "s" : "");
    const lastDate = p.visits[0]?.visit_date || "";
    return '<div class="search-result-group" style="animation-delay:'+(i*0.06)+'s">' +
      '<button class="search-result-patient" onclick="showPatientTimeline(\''+esc(p.name)+'\',\''+esc(p.id||"")+'\')">'+
      '<div class="search-result-info"><div class="search-result-avatar">'+initials+'</div><div><div class="search-result-name">'+esc(p.name)+'</div><div class="search-result-meta">'+(p.id?"ID: "+esc(p.id)+" ¬∑ ":"")+'Last visit: '+lastDate+'</div></div></div>'+
      '<div class="search-result-visits">'+visitText+'</div></button></div>';
  }).join("");
}

// ===== PATIENT TIMELINE =====
async function showPatientTimeline(name, patientId){
  closeSearch(); closeSaved();
  const panel = document.getElementById("patientTimelinePanel");
  document.getElementById("timelinePatientName").textContent = name;
  document.getElementById("timelinePatientId").textContent = patientId ? "ID: " + patientId : "";
  document.getElementById("timelineList").innerHTML = '<div class="saved-empty">Loading records...</div>';
  panel.classList.add("visible");

  try{
    let query = db.from("patient_notes")
      .select("id, patient_name, patient_id, visit_date, structured_notes, recommendations, created_at")
      .eq("status","active")
      .order("visit_date",{ascending:false});

    if(patientId) query = query.eq("patient_id", patientId);
    else query = query.ilike("patient_name", "%"+name+"%");

    const { data, error } = await query.limit(50);
    if(error) throw error;

    const records = data || [];
    document.getElementById("timelineCount").innerHTML = 'üìã ' + records.length + " record" + (records.length !== 1 ? "s" : "") + " found";

    if(!records.length){
      document.getElementById("timelineList").innerHTML = '<div class="saved-empty">No records found for this patient.</div>';
      return;
    }

    document.getElementById("timelineList").innerHTML = records.map((n, i) => {
      const notes = n.structured_notes || {};
      const diagnosis = notes.assessment_diagnosis || notes.subjective_chief_complaint || "";
      const treatment = notes.plan_treatment_performed || "";
      const hasRecs = n.recommendations && n.recommendations.length > 0;
      const isLast = i === records.length - 1;

      return '<button class="timeline-item" onclick="loadNote(\''+n.id+'\')" style="animation:fadeInUp 0.4s '+(i*0.08)+'s both cubic-bezier(0.16,1,0.3,1);">'+
        '<div class="timeline-line"><div class="timeline-dot"></div>'+(isLast?'':'<div class="timeline-connector"></div>')+'</div>'+
        '<div class="timeline-content"><div class="timeline-date">'+n.visit_date+'</div>'+
        (diagnosis ? '<div class="timeline-diagnosis">'+esc(diagnosis.substring(0,80))+(diagnosis.length>80?'...':'')+'</div>':'')+
        (treatment ? '<div class="timeline-treatment">'+esc(treatment.substring(0,100))+(treatment.length>100?'...':'')+'</div>':'')+
        '<div class="timeline-badges">'+(hasRecs?'<span class="timeline-badge has-recs">üí° '+n.recommendations.length+' recommendations</span>':'')+'</div>'+
        '</div></button>';
    }).join("");

    await logAudit("view_patient_history","patient_notes",null,{patient_name:name, patient_id:patientId, record_count:records.length});
  }catch(e){
    document.getElementById("timelineList").innerHTML = '<div class="saved-empty">Failed to load records.</div>';
  }
}

function closeTimeline(){ document.getElementById("patientTimelinePanel").classList.remove("visible"); }

function startNew(){
  rawTranscript="";structuredNotes=null;recommendations=null;currentNoteId=null;
  document.getElementById("patientName").value="";document.getElementById("patientId").value="";
  document.getElementById("visitDate").value=new Date().toISOString().split("T")[0];
  document.getElementById("manualInput").value="";
  document.getElementById("structuredView").classList.remove("visible");
  document.getElementById("recordView").classList.remove("hidden");
  document.getElementById("recsPanel").classList.remove("visible");
  closeSaved(); closeSearch(); closeTimeline();
  document.getElementById("btnNew").classList.remove("visible");
  document.getElementById("patientHistory").classList.remove("visible");
  document.getElementById("validationMsg").classList.remove("visible");
  removeScannedImage();
  updateTranscriptDisplay("");updateProcessBtn();
  window.scrollTo({ top: 0, behavior: "smooth" });
}

// ===== EXPORT =====
function buildPlainText(){
  const name=document.getElementById("patientName").value,id=document.getElementById("patientId").value,date=document.getElementById("visitDate").value;
  let t="DENTAL CLINICAL NOTES (SOAP FORMAT)\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";
  if(name)t+="Patient: "+name+"\n";if(id)t+="ID: "+id+"\n";
  t+="Date: "+date+"\nProvider: Dr. Amira Mahmoud\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n";
  Object.entries(SECTION_GROUPS).forEach(([g,keys])=>{keys.filter(k=>structuredNotes[k]&&String(structuredNotes[k]).trim()).forEach(k=>{t+=LABELS[k].toUpperCase()+"\n"+structuredNotes[k]+"\n\n";});});
  if(recommendations&&recommendations.length){t+="‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nAI CLINICAL CONSIDERATIONS (Advisory)\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n";recommendations.forEach(r=>t+="‚Ä¢ ["+r.category.toUpperCase()+"] "+r.title+"\n  "+r.detail+"\n");t+="\n";}
  t+="‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nDocumented via DentaVoice\n";return t;
}

function copyAll(){
  if(!structuredNotes)return;
  navigator.clipboard.writeText(buildPlainText()).then(()=>{const b=document.getElementById("btnCopy");b.classList.add("copied");b.innerHTML="‚úì Copied!";setTimeout(()=>{b.classList.remove("copied");b.innerHTML="üìã Copy";},2000);});
  logAudit("copy_note","patient_notes",currentNoteId,{});
}

function exportPDF(){
  if(!structuredNotes)return;
  const{jsPDF}=window.jspdf;const doc=new jsPDF();
  const name=document.getElementById("patientName").value,id=document.getElementById("patientId").value,date=document.getElementById("visitDate").value;
  const pageW=doc.internal.pageSize.getWidth();let y=20;
  doc.setFillColor(15,23,42);doc.rect(0,0,pageW,35,"F");
  doc.setTextColor(255,255,255);doc.setFontSize(18);doc.setFont(undefined,"bold");
  doc.text("DentaVoice ‚Äî Clinical Notes",14,15);
  doc.setFontSize(10);doc.setFont(undefined,"normal");
  doc.text("SOAP Format ¬∑ Dr. Amira Mahmoud",14,23);
  doc.text("Generated: "+new Date().toLocaleString(),14,30);
  y=45;doc.setTextColor(0,0,0);doc.setFontSize(11);doc.setFont(undefined,"bold");
  if(name){doc.text("Patient: "+name,14,y);y+=6;}if(id){doc.text("ID: "+id,14,y);y+=6;}
  doc.text("Visit Date: "+date,14,y);y+=10;doc.setDrawColor(200);doc.line(14,y,pageW-14,y);y+=8;
  Object.entries(SECTION_GROUPS).forEach(([g,keys])=>{keys.filter(k=>structuredNotes[k]&&String(structuredNotes[k]).trim()).forEach(key=>{if(y>265){doc.addPage();y=20;}doc.setFontSize(9);doc.setFont(undefined,"bold");doc.setTextColor(37,99,235);doc.text(LABELS[key].toUpperCase(),14,y);y+=5;doc.setFontSize(10);doc.setFont(undefined,"normal");doc.setTextColor(60,60,60);doc.splitTextToSize(String(structuredNotes[key]),pageW-28).forEach(line=>{if(y>275){doc.addPage();y=20;}doc.text(line,14,y);y+=5;});y+=4;});});
  doc.setFontSize(8);doc.setTextColor(150);doc.text("Confidential ‚Äî PHIPA/PIPEDA Protected ¬∑ DentaVoice",14,290);
  doc.save("DentaVoice_"+(name||"Note").replace(/\s+/g,"_")+"_"+date+".pdf");
  logAudit("export_pdf","patient_notes",currentNoteId,{});showToast("‚úì PDF downloaded");
}

function exportCSV(){
  if(!structuredNotes)return;
  const name=document.getElementById("patientName").value,id=document.getElementById("patientId").value,date=document.getElementById("visitDate").value;
  let csv="Section,Content\n";csv+='"Patient Name","'+(name||"").replace(/"/g,'""')+'"\n';csv+='"Patient ID","'+(id||"").replace(/"/g,'""')+'"\n';
  csv+='"Visit Date","'+date+'"\n';csv+='"Provider","Dr. Amira Mahmoud"\n';
  Object.entries(SECTION_GROUPS).forEach(([g,keys])=>{keys.filter(k=>structuredNotes[k]&&String(structuredNotes[k]).trim()).forEach(k=>{csv+='"'+LABELS[k].replace(/"/g,'""')+'","'+String(structuredNotes[k]).replace(/"/g,'""')+'"\n';});});
  const blob=new Blob([csv],{type:"text/csv"});const url=URL.createObjectURL(blob);const a=document.createElement("a");a.href=url;
  a.download="DentaVoice_"+(name||"Note").replace(/\s+/g,"_")+"_"+date+".csv";a.click();URL.revokeObjectURL(url);
  logAudit("export_csv","patient_notes",currentNoteId,{});showToast("‚úì CSV downloaded");
}

// ===== HELPERS =====
function showError(msg){document.getElementById("errorText").textContent=msg;document.getElementById("errorBox").classList.add("visible");}
function hideError(){document.getElementById("errorBox").classList.remove("visible");}
function showToast(msg){const t=document.getElementById("toast");t.textContent=msg;t.classList.add("show");setTimeout(()=>t.classList.remove("show"),2500);}
function showLoading(s){document.getElementById("loadingStep").textContent=s;document.getElementById("loadingOverlay").classList.add("visible");}
function updateLoadingStep(s){document.getElementById("loadingStep").textContent=s;}
function hideLoading(){document.getElementById("loadingOverlay").classList.remove("visible");}
function esc(str){const d=document.createElement("div");d.textContent=str||"";return d.innerHTML;}
</script>
</body>
</html>
